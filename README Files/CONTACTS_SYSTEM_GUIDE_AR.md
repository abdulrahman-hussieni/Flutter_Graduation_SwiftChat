# ุดุฑุญ ูุธุงู ุงูุฃุตุฏูุงุก (Contacts System)

## ๐ฏ ุงูุชุญุฏูุซุงุช ุงููู ุงุชุนููุช

### 1๏ธโฃ ุงูุจุญุซ ุจุงูุงุณู ุจุฏู ุงูุฅูููู
- **ูุจู:** ูุงู ูุงุฒู ุชูุชุจ ุงูุฅูููู ุจุงูุธุจุท ุนุดุงู ุชูุงูู ุงูุดุฎุต
- **ุฏูููุชู:** ุงูุชุจ ุฃู ุฌุฒุก ูู ุงูุงุณู ูููุธูุฑูู ูู ุงููุงุณ ุงููู ุงุณููู ููู ุงููููุฉ ุฏู

**ูุซุงู:**
- ูู ูุชุจุช "ูุญูุฏ" โ ููุธูุฑูู ูู ุงููุงุณ ุงููู ุงุณููู ููู ูุญูุฏ
- ูู ูุชุจุช "mah" โ ููุธูุฑูู Mahmoud, Mahmoud Abdelghani, ููู ุงูุฃุณูุงุก ุงูุดุจููุฉ

### 2๏ธโฃ ุนุฑุถ ูู ุงููุชุงุฆุฌ ูุด ูุชูุฌุฉ ูุงุญุฏุฉ
- **ูุจู:** ูุงู ุจูุธูุฑูู ุฃูู ุดุฎุต ุจุณ
- **ุฏูููุชู:** ุจูุธูุฑูู ูู ุงููุงุณ ุงููู ุงุณููู ููู ุงููููุฉ ุงููู ุงูุช ูุชุจุชูุง ูู **ูุงููุฉ**

### 3๏ธโฃ ุญู ูุดููุฉ ุงูู ListView
- **ุงููุดููุฉ:** ูุงู ูู error "Vertical viewport was given unbounded height"
- **ุงูุญู:** ุญุทูุช `SizedBox(height: 400)` ุญูุงููู ุงูู StreamBuilder

### 4๏ธโฃ ูุธุงู ุงูุฃุตุฏูุงุก ูู Firebase
ูุนู! ูู ููุฒุฑ ูููู ูุจูู ููู ุฃุตุฏูุงุก ุฎุงุตูู ุจูู ูู Firebase

**ุงููููู:**
```
๐ Firestore Database
  โโโ ๐ users (ูู ุงููุณุชุฎุฏููู)
       โโโ ๐ userId (ูุณุชุฎุฏู ูุนูู)
            โโโ name: "Mahmoud"
            โโโ email: "mahmoud@gmail.com"
            โโโ ๐ contacts (ุงูุฃุตุฏูุงุก ุจุชูุน ุงููุณุชุฎุฏู ุฏู)
                 โโโ ๐ contactId1 (ุตุฏูู 1)
                 โ    โโโ name: "Ahmed"
                 โ    โโโ email: "ahmed@gmail.com"
                 โโโ ๐ contactId2 (ุตุฏูู 2)
                      โโโ name: "Ali"
                      โโโ email: "ali@gmail.com"
```

## ๐ Firebase Security Rules ุงููุทููุจุฉ

**ูุงุฒู ุชูุณุฎ ุงูููุงุนุฏ ุฏู ูุชุญุทูุง ูู Firebase Console:**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection
    match /users/{userId} {
      // ุฃู ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู ููุฏุฑ ููุฑุฃ ูุนูููุงุช ุฃู ูุณุชุฎุฏู ุชุงูู
      // (ุนุดุงู ุงูุจุญุซ ุนู ุงูุฃุตุฏูุงุก ูุดุชุบู)
      allow read: if request.auth != null;
      
      // ุจุณ ูู ูุณุชุฎุฏู ููุฏุฑ ูุนุฏู ุนูู ุจูุงูุงุชู ูู ุจุณ
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // Sub-collection: contacts (ูุงุฆูุฉ ุงูุฃุตุฏูุงุก)
      // ูู ูุณุชุฎุฏู ููุฏุฑ ููุฑุฃ ูููุชุจ ูู ูุงุฆูุฉ ุฃุตุฏูุงุกู ุจุณ
      match /contacts/{contactId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Sub-collection: calls (ูุงุฆูุฉ ุงูููุงููุงุช)
      match /calls/{callId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Chats collection
    match /chats/{chatId} {
      allow read, write: if request.auth != null;
      
      match /messages/{messageId} {
        allow read, write: if request.auth != null;
      }
    }
    
    // Groups collection
    match /groups/{groupId} {
      allow read, write: if request.auth != null;
      
      match /messages/{messageId} {
        allow read, write: if request.auth != null;
      }
    }
    
    // Notifications
    match /notification/{userId} {
      allow read, write: if request.auth != null;
      
      match /call/{callId} {
        allow read, write: if request.auth != null;
      }
    }
  }
}
```

## ๐ ุฎุทูุงุช ุชุทุจูู ุงูู Firebase Rules

### 1. ุงูุชุญ Firebase Console
1. ุฑูุญ ุนูู: https://console.firebase.google.com/
2. ุงุฎุชุงุฑ ูุดุฑูุนู: **graduation_swiftchat**

### 2. ุนุฏูู Firestore Security Rules
1. ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉุ ุงุฎุชุงุฑ **Firestore Database**
2. ุงุถุบุท ุนูู ุชุงุจ **Rules**
3. ุงุญุฐู ูู ุงูููุงุนุฏ ุงููุฏููุฉ
4. ุงูุณุฎ ุงูููุงุนุฏ ุงููู ููู ุฏู ูุงูุตููุง
5. ุงุถุบุท **Publish**

### 3. ุงุณุชูู ุดููุฉ (ุญูุงูู 1-2 ุฏูููุฉ)
ุงูู Firebase ุจูุงุฎุฏ ููุช ุจุณูุท ุนุดุงู ูุทุจูู ุงูููุงุนุฏ ุงูุฌุฏูุฏุฉ

### 4. ุฌุฑุจ ุงูุชุทุจูู
```bash
flutter run
```

## ๐ฎ ููููุฉ ุงุณุชุฎุฏุงู ูุธุงู ุงูุฃุตุฏูุงุก

### ุฅุถุงูุฉ ุตุฏูู ุฌุฏูุฏ:
1. ุงูุชุญ ุงูุชุทุจูู
2. ุฑูุญ ุนูู ุชุงุจ **Contacts**
3. ุงุถุบุท ุนูู **New contact**
4. ุงูุชุจ ุงุณู ุงูุดุฎุต (ุฃู ุฌุฒุก ููู)
5. ุงุถุบุท ุนูู ุฃููููุฉ ุงูุจุญุซ ๐
6. ููุธูุฑูู ูู ุงููุงุณ ุงููู ุงุณููู ููู ุงููููุฉ ุฏู
7. ุงุถุบุท ุนูู ุฃููููุฉ **+ (Add)** ุฌูุจ ุงูุดุฎุต ุงููู ุนุงูุฒู
8. โ ุชู ุฅุถุงูุฉ ุงูุตุฏูู!

### ูุดุงูุฏุฉ ุงูุฃุตุฏูุงุก:
1. ุฑูุญ ุนูู ุชุงุจ **Contacts**
2. ุชุญุช ุนููุงู **My Contacts** ูุชูุงูู ูู ุฃุตุฏูุงุกู
3. ุงุถุบุท ุนูู ุฃู ุตุฏูู ุนุดุงู ุชูุชุญ ูุญุงุฏุซุฉ ูุนุงู

### ุจุฏุก ูุญุงุฏุซุฉ ูุจุงุดุฑุฉ ูู ุงูุจุญุซ:
1. ุจุนุฏ ูุง ุชุจุญุซ ุนู ุดุฎุต
2. ุงุถุบุท ุนูู ุฃููููุฉ **๐ฌ (Chat)** ุฌูุจ ุงุณูู
3. ูููุชุญูู ูุญุงุฏุซุฉ ูุจุงุดุฑุฉ ูุนุงู (ุญุชู ูู ูุด ูู ุงูุฃุตุฏูุงุก)

## ๐ ุญู ุงููุดุงูู

### ูู ุธูุฑูู Error: "Permission Denied"
**ุงูุณุจุจ:** Firebase Rules ูุด ูุชุทุจูุฉ ุตุญ

**ุงูุญู:**
1. ุชุฃูุฏ ุฅูู ูุณุฎุช ุงูู Rules ูู ููู ุตุญ
2. ุชุฃูุฏ ุฅูู ุถุบุทุช **Publish** ูู Firebase Console
3. ุงุณุชูู ุฏูููุฉ ูุงุญุฏุฉ
4. ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู: `flutter run`

### ูู ุงูุจุญุซ ูุด ุฑุงุถู ูุดุชุบู
**ุงูุญู:**
1. ุชุฃูุฏ ุฅูู ูุณุฌู ุฏุฎูู ูู ุงูุชุทุจูู
2. ุชุฃูุฏ ุฅู ูู users ูู ุงูู Firestore
3. ุฌุฑุจ ุชุจุญุซ ุจุญุฑูู ููููุฉ (ูุซูุงู "mah" ุจุฏู "Mahmoud")

### ูู ูุงุฆูุฉ ุงูุฃุตุฏูุงุก ูุงุถูุฉ
**ุงูุณุจุจ:** ูุถูุชุด ุฃู ุญุฏ ูุณู

**ุงูุญู:**
1. ุงุถุบุท **New contact**
2. ุงุจุญุซ ุนู ุดุฎุต
3. ุงุถุบุท **Add Contact**
4. ุงุฑุฌุน ููุงุฆูุฉ Contacts

### ูู ุธูุฑ Error: "Vertical viewport unbounded height"
**ุงูุญู:** ุชู ุญูู! ุงูููุฏ ุฏูููุชู ููู `SizedBox(height: 400)` ุญูุงููู ุงูู ListView

## ๐ ุงููููุงุช ุงููู ุงุชุนุฏูุช

### 1. `lib/pages/contact_page/add_contact_page.dart`
**ุงูุชุบููุฑุงุช:**
- โ ุชุบููุฑ ุงูุจุญุซ ูู email ุฅูู name
- โ ุงูุจุญุซ ุจููุจู ุฃู ุฌุฒุก ูู ุงูุงุณู (case-insensitive)
- โ ุนุฑุถ ูู ุงููุชุงุฆุฌ ูู ูุงุฆูุฉ ุจุฏู ูุชูุฌุฉ ูุงุญุฏุฉ
- โ ุฅุถุงูุฉ ุฒุฑุงุฑ Chat ุฌูุจ ูู ูุชูุฌุฉ

**ุงูููุฏ ุงูููู:**
```dart
// ุงูุจุญุซ ุจุงูุงุณู
final users = contactController.userList
    .where((user) => 
        user.name?.toLowerCase().contains(
            searchController.text.toLowerCase()) ?? false)
    .toList();

// ุนุฑุถ ูู ุงููุชุงุฆุฌ
foundUsers.value = users;
```

### 2. `lib/pages/contact_page/contact_page.dart`
**ุงูุชุบููุฑุงุช:**
- โ ุญู ูุดููุฉ ListView unbounded height
- โ ุฅุถุงูุฉ `SizedBox(height: 400)` ุญูุงููู StreamBuilder

**ุงูููุฏ ุงูููู:**
```dart
SizedBox(
  height: 400,  // โ ุงูุญู ููู ListView error
  child: StreamBuilder(
    stream: contactController.getContacts(),
    // ...
  ),
)
```

## โก ูููุฒุงุช ุงููุธุงู ุงูุฌุฏูุฏ

### โ ุงูุจุญุซ ุงูุฐูู
- ูุด ูุญุชุงุฌ ุชูุชุจ ุงูุงุณู ูุงูู
- ูุด ุญุณุงุณ ูุญุงูุฉ ุงูุญุฑูู (Capital/Small)
- ุจูุจุญุซ ูู ูู ุฃุฌุฒุงุก ุงูุงุณู

### โ ูุชุงุฆุฌ ูุชุนุฏุฏุฉ
- ูุนุฑุถ ูู ุงููุงุณ ุงููู ุงุณููู ููู ุงููููุฉ ุงููู ุจุญุซุช ุนููุง
- ูู ูุงุญุฏ ูู ูุงุฑุฏ ูููุตู
- ุณูู ุชุถูู ุฃู ุญุฏ ูููู

### โ ุฎูุงุฑุงุช ุณุฑูุนุฉ
- ุฒุฑุงุฑ **Add Contact** ูุฅุถุงูุฉ ุงูุตุฏูู
- ุฒุฑุงุฑ **Chat** ูุจุฏุก ูุญุงุฏุซุฉ ููุฑุงู
- ูุด ูุญุชุงุฌ ุชุถููู ุตุฏูู ุนุดุงู ุชูููู

### โ ูุงุฆูุฉ ุฃุตุฏูุงุก ุฎุงุตุฉ
- ูู ูุณุชุฎุฏู ูู ูุงุฆูุฉ ุฃุตุฏูุงุก ุฎุงุตุฉ ุจูู ูู Firebase
- ุงูุฃุตุฏูุงุก ุจูุชุญูุธูุง ูู: `users/{userId}/contacts/`
- ุจูุธูุฑูุง ูู ุตูุญุฉ Contacts

## ๐ ุงูุฃูุงู

### ููู ุงูุฃูุงู ุจูุดุชุบูุ
1. **ุงููุฑุงุกุฉ:** ุฃู ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู ููุฏุฑ ููุฑุฃ ูุนูููุงุช ุงููุณุชุฎุฏููู ุงูุชุงูููู (ุนุดุงู ุงูุจุญุซ)
2. **ุงููุชุงุจุฉ:** ูู ูุณุชุฎุฏู ููุฏุฑ ูุนุฏู ุนูู ุจูุงูุงุชู ูู ุจุณ
3. **ุงูุฃุตุฏูุงุก:** ูู ูุณุชุฎุฏู ููุฏุฑ ูุถูู/ููุณุญ ูู ูุงุฆูุฉ ุฃุตุฏูุงุกู ุจุณ

### ุงูููุงุนุฏ ุงูุฃูููุฉ:
```javascript
// ูู ูุงุญุฏ ููุฏุฑ ููุฑุฃ ูุนูููุงุช ุฃู ุญุฏ (ููุจุญุซ)
allow read: if request.auth != null;

// ุจุณ ููุฏุฑ ูุนุฏู ุนูู ุจูุงูุงุชู ูู ุจุณ
allow write: if request.auth.uid == userId;

// ุงูุฃุตุฏูุงุก: ูู ูุงุญุฏ ูุชุญูู ูู ูุงููุชู ูู ุจุณ
match /contacts/{contactId} {
  allow read, write: if request.auth.uid == userId;
}
```

## ๐ฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู

### ุตูุญุฉ ุงูุจุญุซ (AddContactPage)
- **ูู ุงูุฃุนูู:** ุญูู ุงูุจุญุซ ุจุฃููููุฉ ๐
- **ูู ุงููุต:** ุฅูุง:
  - ุฃููููุฉ ุจุญุซ ๐ + "Search for users by name" (ูุจู ุงูุจุญุซ)
  - ูุงุฆูุฉ ุจูู ุงููุชุงุฆุฌ (ุจุนุฏ ุงูุจุญุซ)
  - "No users found" (ูู ูููุด ูุชุงุฆุฌ)

### ุจุทุงูุฉ ูู ูุชูุฌุฉ (User Card)
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ค  Mahmoud Abdelghani         โ
โ      mahmoud@gmail.com           โ
โ                        [+] [๐ฌ] โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุตูุญุฉ ุงูุฃุตุฏูุงุก (ContactPage)
```
โโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ Search          โ
โโโโโโโโโโโโโโโโโโโโโโโค
โ  โ New contact     โ
โ  ๐ฅ New Group       โ
โโโโโโโโโโโโโโโโโโโโโโโค
โ  My Contacts        โ
โโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ฑ Ahmed           โ
โ     Hey there       โ
โโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ฑ Ali             โ
โ     Available       โ
โโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ ูููุทูุฑูู

### ููู ุชุนูู ุงูู Sub-Collectionsุ
```dart
// ุญูุธ ุตุฏูู ูู sub-collection
await FirebaseFirestore.instance
  .collection('users')
  .doc(currentUserId)           // ุงููุณุชุฎุฏู ุงูุญุงูู
  .collection('contacts')       // โ Sub-collection
  .doc(friendId)                // ุงูุตุฏูู
  .set(friendData);

// ูุฑุงุกุฉ ุงูุฃุตุฏูุงุก
Stream<List<UserModel>> getContacts() {
  return FirebaseFirestore.instance
    .collection('users')
    .doc(currentUserId)
    .collection('contacts')     // โ Sub-collection
    .snapshots()
    .map((snapshot) => 
      snapshot.docs.map((doc) => 
        UserModel.fromJson(doc.data())
      ).toList()
    );
}
```

### ูููุฒุงุช ุงูู Sub-Collections:
1. **ููุธูุฉ:** ูู ูุณุชุฎุฏู ูู ุฃุตุฏูุงุกู ุงูุฎุงุตุฉ
2. **ุขููุฉ:** Firestore Rules ุจุชุชุญูู ูู ุงููุตูู
3. **ุณุฑูุนุฉ:** ุจุชุฌูุจ ุฃุตุฏูุงุก ูุณุชุฎุฏู ูุงุญุฏ ุจุณ ูุด ูู ุงูู Database
4. **ูุงุจูุฉ ููุชูุณุน:** ูููู ุชุถูู sub-collections ุชุงููุฉ ุฒู:
   - `users/{userId}/calls/` ููููุงููุงุช
   - `users/{userId}/favorites/` ููููุถูุฉ
   - `users/{userId}/blocked/` ูููุญุธูุฑูู

## ๐ ุฎุทูุงุช ุงูุชุดุบูู ุงูููุงุฆูุฉ

1. **ุชุทุจูู Firebase Rules:**
   - ุงูุณุฎ ุงูููุงุนุฏ ูู ููู
   - ุงูุตููุง ูู Firebase Console โ Firestore โ Rules
   - ุงุถุบุท Publish

2. **ุชูุธูู ุงูุจูุงุก:**
   ```bash
   flutter clean
   flutter pub get
   ```

3. **ุชุดุบูู ุงูุชุทุจูู:**
   ```bash
   flutter run
   ```

4. **ุงุฎุชุจุงุฑ ุงูููุฒุงุช:**
   - โ ุณุฌู ุฏุฎูู
   - โ ุฑูุญ Contacts
   - โ ุงุถุบุท New contact
   - โ ุงุจุญุซ ุจุงูุงุณู
   - โ ุงุถู ุตุฏูู
   - โ ุดูู ูุงุฆูุฉ ุฃุตุฏูุงุกู

## ๐ ุงูุชูุงุตู

ูู ุนูุฏู ุฃู ูุดููุฉ ุฃู ุณุคุงูุ ุงุฑุฌุน ูููููุงุช ุฏู:
- `FIRESTORE_RULES_FIX.md` - ุดุฑุญ Firebase Rules
- `CONTACTS_GUIDE.md` - ุฏููู ุงูุงุณุชุฎุฏุงู ุจุงูุฅูุฌููุฒู
- `FIXES_SUMMARY.md` - ููุฎุต ูู ุงูุชุตููุญุงุช

---

**โจ ุชู ุจุญูุฏ ุงููู! ูุธุงู ุงูุฃุตุฏูุงุก ุดุบุงู 100%**
